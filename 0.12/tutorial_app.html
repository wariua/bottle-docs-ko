
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>따라하기: 할일 목록 응용 &#8212; Bottle 0.12.18 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="비동기 응용 입문" href="async.html" />
    <link rel="prev" title="Bottle-Werkzeug" href="plugins/werkzeug.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="id3">
<h1>따라하기: 할일 목록 응용<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>작업 중인 문서이고 작성자는 <a class="reference external" href="http://github.com/noisefloor">noisefloor</a>다.</p>
</div>
<p>이 따라하기에선 <a class="reference external" href="http://bottle.paws.org">Bottle</a> WSGI 프레임워크를 간단히 소개할 것이다. 이 따라하기를 읽고 나면 보틀을 이용해 프로젝트를 만들 수 있게 하는 게 주된 목표다. 이 문서 안에서 모든 기능들을 살펴보진 못하지만 적어도 라우팅, 보틀 템플릿 이용 출력 포매팅, GET / POST 매개변수 다루기 같은 중요한 것들은 살펴볼 것이다.</p>
<p>내용을 이해하기 위해 WSGI에 대한 기본 지식이 있어야 하는 건 아니다. 보틀이 하려는 게 바로 WSGI를 사용자에게서 떨어뜨리는 거다. 하지만 <a class="reference external" href="http://www.python.org">Python</a> 프로그래밍 언어는 적당히 이해하고 있어야 한다. 그리고 이 따라하기의 예시에서 SQL 데이터베이스에 데이터를 저장하고 읽어 오니까 SQL에 대한 기본 지식이 도움이 된다. 하지만 보틀 개념을 이해하는 데 필수는 아니다. 여기선 <a class="reference external" href="http://www.sqlite.org">SQLite</a>를 쓴다. 일부 예시에선 보틀이 브라우저로 보내는 출력에 HTML로 서식을 준다. 따라서 많이 쓰는 HTML 태그에 대한 기본 지식 역시 도움이 된다.</p>
<p>보틀을 소개한다는 취지에 따라 집중을 위해 내용 중간 중간의 파이썬 코드는 짧게 작성한다. 그리고 따라하기 내의 모든 코드는 동작은 잘 하지만 “야생에서” (가령 공개 웹 서버에서) 사용하기에 꼭 괜찮은 건 아니다. 그렇게 하려면 오류 처리 등을 더 추가하고, 데이터베이스를 패스워드로 보호하고, 입력을 검사하고 이스케이프 처리 등을 할 수 있다.</p>
<div class="contents local topic" id="id4">
<p class="topic-title">차례</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id5" id="id11">목표</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id12">시작하기 전에…</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id13">보틀 이용해 웹 기반 할일 목록 만들기</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id14">서버 구성</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id15">끝으로</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id16">전체 예시 코드</a></p></li>
</ul>
</div>
<section id="id5">
<h2><a class="toc-backref" href="#id11">목표</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>이 따라하기가 끝나면 간단한 웹 기반 할일 목록 앱이 생기게 된다. 그 목록에는 항목마다 텍스트(최대 100글자)와 상태(0은 완료, 1은 미완료)가 있다. 웹 기반 사용자 인터페이스를 통해 미완료 항목을 보고 편집할 수 있으며 새 항목을 추가할 수 있다.</p>
<p>개발 중에는 모든 페이지를 <code class="docutils literal notranslate"><span class="pre">localhost</span></code>에서만 볼 수 있지만 이후에 Apache mod_wsgi 사용법을 포함해 응용을 “진짜” 서버에 얹는 방법을 보게 될 것이다.</p>
<p>보틀이 라우팅을 하고 템플릿을 이용해 서식 있는 출력을 만든다. 목록 항목들은 SQLite 데이터베이스에 저장된다. 데이터베이스를 읽고 쓰는 건 파이썬 코드로 한다.</p>
<p>최종적으로 다음 페이지와 기능을 가진 응용이 생기게 된다.</p>
<blockquote>
<div><ul class="simple">
<li><p>시작 페이지 <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/todo</span></code></p></li>
<li><p>목록에 새 항목 추가하기: <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/new</span></code></p></li>
<li><p>항목 편집 페이지: <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/edit/:no</span></code></p></li>
<li><p>&#64;validate 데코레이터로 동적 라우트에 할당된 데이터 검증하기</p></li>
<li><p>오류 잡아내기</p></li>
</ul>
</div></blockquote>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id12">시작하기 전에…</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p class="rubric">보틀 설치</p>
<p>꽤 최근 파이썬(2.5 또는 이상 버전)이 설치돼 있다고 하면 거기에 보틀만 설치해 주면 된다. 보틀은 파이썬 자체 말고 다른 의존성이 없다.</p>
<p>직접 또는 파이썬 easy_install을 이용해 (<code class="docutils literal notranslate"><span class="pre">easy_install</span> <span class="pre">bottle</span></code>) 보틀을 설치할 수 있다.</p>
<p class="rubric">추가 소프트웨어 요건</p>
<p>데이터베이스로 SQLite3을 쓰니까 설치가 돼 있어야 한다. 리눅스 시스템은 대부분 배포판에 기본으로 SQLite3가 설치돼 있다. 윈도우와 MacOS X에서도 SQLite3를 사용 가능하며 <cite>sqlite3</cite> 모듈이 파이썬 표준 라이브러리에 포함돼 있다.</p>
<p class="rubric">SQL 데이터베이스 만들기</p>
<p>일단 이후에 사용할 데이터베이스를 만들어야 한다. 다음 스크립트를 프로젝트 디렉터리에 저장하고 파이썬으로 실행하면 된다. 대화형 인터프리터를 쓸 수도 있다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span> <span class="c1"># 경고: 현재 디렉터리에 파일이 생성된다</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE todo (id INTEGER PRIMARY KEY, task char(100) NOT NULL, status bool NOT NULL)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (&#39;Read A-byte-of-python to get a good introduction into Python&#39;,0)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (&#39;Visit the Python website&#39;,1)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (&#39;Test various editors for and check the syntax highlighting&#39;,1)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (&#39;Choose your favorite WSGI-Framework&#39;,0)&quot;</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>데이터베이스 <cite>todo.db</cite>가 생기고 그 안의 <code class="docutils literal notranslate"><span class="pre">todo</span></code>라는 테이블에 칼럼 <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">task</span></code>, <code class="docutils literal notranslate"><span class="pre">status</span></code>가 있다. <code class="docutils literal notranslate"><span class="pre">id</span></code>는 각 행의 고유 ID이고 이후 행을 참조하는 데 쓴다. <code class="docutils literal notranslate"><span class="pre">task</span></code> 칼럼은 작업을 설명하는 텍스트를 담으며 최대 100글자 길이다. 마지막의 <code class="docutils literal notranslate"><span class="pre">status</span></code> 칼럼은 작업 미완료(1) 또는 완료(0)를 표시하는 데 쓴다.</p>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id13">보틀 이용해 웹 기반 할일 목록 만들기</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>이제 웹 기반 응용을 만들기 위해 보틀을 등장시킬 차례다. 하지만 먼저 보틀의 기본 개념 하나를 살펴볼 필요가 있다. 바로 라우트다.</p>
<p class="rubric">라우트란</p>
<p>기본적으로 브라우저에 보이는 각 페이지는 페이지 주소가 호출될 때 동적으로 생성된다. 즉 정적 콘텐츠가 전혀 없다. 그게 바로 보틀에서 “라우트”라고 부르는 것, 즉 서버 상의 특정 주소다. 그래서 예를 들어 브라우저에서 페이지 <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/todo</span></code>를 요청하면 보틀이 그 요청을 “잡아채서” 그 “todo”라는 라우트에 대해 정의된 (파이썬) 함수가 있는지 확인한다. 있으면 대응하는 파이썬 코드를 실행하고 그 결과를 반환하게 된다.</p>
<p class="rubric">첫 단계 - 미완료 항목 모두 표시하기</p>
<p>라우트 개념을 이해했으니 첫 번째 라우트를 만들어 보자. 목표는 할일 목록에서 미완료 항목 전체를 보는 거다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/todo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">todo_list</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, task FROM todo WHERE status LIKE &#39;1&#39;&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>위 코드를 <code class="docutils literal notranslate"><span class="pre">todo.py</span></code>로 저장하자. 이왕이면 <code class="docutils literal notranslate"><span class="pre">todo.db</span></code> 파일과 같은 디렉터리가 좋다. 아니라면 <code class="docutils literal notranslate"><span class="pre">sqlite3.connect()</span></code> 문의 <code class="docutils literal notranslate"><span class="pre">todo.db</span></code> 앞에 경로를 붙여 줘야 한다.</p>
<p>뭘 하는지 살펴보자. SQLite 데이터베이스에 접근하기 위해 필요한 모듈 <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code>를 임포트하고 보틀에서 <code class="docutils literal notranslate"><span class="pre">route</span></code>와 <code class="docutils literal notranslate"><span class="pre">run</span></code>을 임포트한다. <code class="docutils literal notranslate"><span class="pre">run()</span></code> 문은 보틀에 포함된 웹 서버를 시작하는 거다. 기본으로 그 웹 서버는 localhost 8080 포트에서 페이지를 제공한다. 또 <code class="docutils literal notranslate"><span class="pre">route</span></code>를 임포트했는데, 이건 보틀의 라우팅을 맡는 함수다. 보다시피 <code class="docutils literal notranslate"><span class="pre">todo_list()</span></code>라는 함수를 하나 정의해서 데이터베이스에서 읽어 오는 코드를 몇 줄 작성했다. 중요한 건 <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">todo_list()</span></code> 문 바로 위에 있는 <a class="reference external" href="http://docs.python.org/glossary.html#term-decorator">데코레이터 문</a> <code class="docutils literal notranslate"><span class="pre">&#64;route('/todo')</span></code>다. 그렇게 함수를 라우트 <code class="docutils literal notranslate"><span class="pre">/todo</span></code>에 결속시켜서 브라우저가 <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/todo</span></code> 페이지를 호출할 때마다 보틀이 <code class="docutils literal notranslate"><span class="pre">todo_list()</span></code> 함수의 결과를 반환하게 된다. 보틀 안에서 이렇게 라우팅이 동작한다.</p>
<p>한 함수에 라우트를 여러 개 결속시킬 수도 있다. 그래서 다음 코드도 잘 동작한다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/todo&#39;</span><span class="p">)</span>
<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/my_todo_list&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">todo_list</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>하지만 한 라우트를 여러 함수에 결속시키는 건 안 된다.</p>
<p>브라우저에서 보게 되는 건 반환된 내용, 즉 <code class="docutils literal notranslate"><span class="pre">return</span></code> 문이 내놓은 값이다. 이 예에선 <code class="docutils literal notranslate"><span class="pre">result</span></code>를 <code class="docutils literal notranslate"><span class="pre">str()</span></code>로 문자열로 변환해 줘야 한다. 보틀은 return 문에서 문자열 또는 문자열 리스트를 기대하는데 여기서 데이터베이스 질의의 결과물은 <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">Python DB API</a>에서 규정하는 대로 튜플의 리스트이기 때문이다.</p>
<p>이제 위 스크립트를 좀 이해했으니 직접 실행해서 결과를 살펴보자. 리눅스/유닉스 기반 시스템에서 <code class="docutils literal notranslate"><span class="pre">todo.py</span></code> 파일이 실행 가능해야 한다는 걸 잊지 말자. 그럼 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">todo.py</span></code>를 실행하고 브라우저에서 <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/todo</span></code> 페이지를 호출하자. 스크립트를 입력하며 실수를 하지 않았다면 다음처럼 나올 것이다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Visit the Python website&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Test various editors for and check the syntax highlighting&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>이렇게 나왔다면, 축하한다! 이제 엄연한 보틀 사용자가 됐다. 잘 동작하지 않아서 스크립트에서 뭔가 변경해야 한다면 페이지를 제공 중인 보틀을 멈추는 걸 잊지 말자. 안 그러면 바뀐 버전이 올라가지 않는다.</p>
<p>그런데 출력이 그렇게 흥미롭지도 않고 읽기에 좋지도 않다. SQL 질의가 반환한 그대로의 결과라 그렇다.</p>
<p>그럼 다음 단계에선 좀 보기 좋게 출력에 서식을 주자. 하지만 그 전에 일을 좀 쉽게 만들어 두자.</p>
<p class="rubric">디버깅과 자동 재적재</p>
<p>스크립트에 뭔가 잘못된 게 있으면, 가령 데이터베이스 연결이 동작하지 않으면 보틀이 브라우저로 짧은 오류 메시지를 보낸다는 걸 벌써 알아챘을 수도 있겠다. 디버깅을 위해선 그보다 자세한 내용을 얻을 수 있으면 상당히 도움이 된다. 스크립트에 다음 문을 추가해 주기만 하면 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">debug</span>
<span class="o">...</span>
<span class="c1"># 끝에 이렇게 추가:</span>
<span class="n">debug</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>“debug”를 켜면 파이썬 인터프리터의 전체 스택트레이스를 얻게 되는데, 일반적으로 버그를 찾는 데 필요한 유용한 정보가 담겨 있다. 또한 템플릿(아래 참고)을 캐싱하지 않으므로 서버를 멈추지 않아도 템플릿 변경 효과가 바로 나타난다.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">debug(True)</span></code>는 개발용으로 쓰기 위한 것이다. 운용 환경에서 사용해선 <em>안 된다</em>.</p>
</div>
<p>또 다른 멋진 기능으로 자동 재적재가 있는데, <code class="docutils literal notranslate"><span class="pre">run()</span></code> 문을 다음처럼 바꾸면 켜진다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="n">reloader</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>스크립트 변화를 자동으로 탐지해서 새 버전을 다시 올려 준다. 그래서 한 번만 호출해 두면 서버를 멈추고 시작할 필요가 없다.</p>
<p>마찬가지로 이 기능은 기본적으로 개발 중에 쓰기 위한 것이지 운용 시스템을 위한 게 아니다.</p>
<p class="rubric">보틀 템플릿으로 출력에 서식 주기</p>
<p>이제 스크립트 출력을 제대로 된 형식으로 바꾸는 방법을 살펴보자.</p>
<p>사실 보틀이 하는 건 함수에게서 문자열 또는 문자열 리스트를 받아서 내장 서버의 도움을 받아 브라우저로 반환하는 것이다. 문자열 내용에는 신경쓰지 않으며, 그래서 HTML 마크업으로 형식을 준 텍스트도 가능하다.</p>
<p>보틀에는 쓰기 쉬운 템플릿 엔진이 딸려 있다. 템플릿은 <code class="docutils literal notranslate"><span class="pre">.tpl</span></code> 확장자의 별도 파일로 저장한다. 그러면 함수 안에서 템플릿을 호출할 수 있다. 템플릿에는 어떤 텍스트도 들어갈 수 있다. (대부분 HTML 마크업에 파이썬 문이 섞인 형태일 것이다.) 그리고 템플릿에 인자를 줄 수 있다. 가령 데이터베이스 질의 결과를 주면 템플릿 안에서 멋지게 서식이 더해진다.</p>
<p>이제 미완료 할일 항목들을 보여 주는 질의 결과를 두 열짜리 간단한 테이블로 바꿀 것이다. 첫 번째 열에는 항목 ID, 두 번째 열에는 텍스트가 들어간다. 결과 집합은 위에서 본 것처럼 튜플들의 리스트이고 각 튜플이 항목 하나씩을 담고 있다.</p>
<p>예시에 템플릿을 포함시키려면 다음 행을 추가해 주기만 하면 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">template</span>
<span class="o">...</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;make_table&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
<span class="k">return</span> <span class="n">output</span>
<span class="o">...</span>
</pre></div>
</div>
<p>두 가지를 하고 있다. 첫째로 템플릿을 사용할 수 있도록 보틀에서 <code class="docutils literal notranslate"><span class="pre">template</span></code>을 임포트한다. 둘째로 템플릿 <code class="docutils literal notranslate"><span class="pre">make_table</span></code>의 출력을 변수 <code class="docutils literal notranslate"><span class="pre">output</span></code>에 할당해서 반환한다. 템플릿을 호출할 때는 데이터베이스 질의로 받은 <code class="docutils literal notranslate"><span class="pre">result</span></code>를 변수 <code class="docutils literal notranslate"><span class="pre">rows</span></code>로 할당하는데, 템플릿 내에서 그 변수를 이용하게 된다. 필요하면 템플릿에 여러 변수/값을 할당할 수도 있다.</p>
<p>템플릿은 항상 문자열의 리스트를 반환하며, 따라서 어떤 변환도 필요치 않다. 당연히 <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">template('make_table',</span> <span class="pre">rows=result)</span></code>라고 작성해서 한 행을 줄일 수도 있고, 정확히 위와 같은 결과가 나온다.</p>
<p>이제 해당 템플릿을 작성할 차례다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="c1"># 튜플의 리스트(또는 리스트의 리스트, 튜플의 튜플, ...)로 HTML 테이블을 생성하는 템플릿</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="nb">open</span> <span class="n">items</span> <span class="n">are</span> <span class="k">as</span> <span class="n">follows</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="o">&gt;</span>
<span class="o">%</span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
  <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
  <span class="o">%</span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">col</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
  <span class="o">%</span><span class="n">end</span>
  <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
<span class="o">%</span><span class="n">end</span>
<span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">todo.py</span></code>와 같은 디렉터리에 위 코드를 <code class="docutils literal notranslate"><span class="pre">make_table.tpl</span></code>로 저장하자.</p>
<p>코드를 살펴보자. %로 시작하는 행은 모두 파이썬 코드로 해석한다. 물론 유효한 파이썬 문만 허용되며, 아니면 여느 파이썬 코드와 마찬가지로 템플릿에서 예외를 던진다. 다른 행들은 평범한 HTML 마크업이다.</p>
<p>보다시피 <code class="docutils literal notranslate"><span class="pre">rows</span></code>를 순회하기 위해 파이썬 <code class="docutils literal notranslate"><span class="pre">for</span></code> 문을 두 번 사용하고 있다. 앞서 보았듯 <code class="docutils literal notranslate"><span class="pre">rows</span></code>는 데이터베이스 질의 결과를 담고 있는 변수고, 그래서 튜플들의 리스트다. 첫 번째 <code class="docutils literal notranslate"><span class="pre">for</span></code> 문은 리스트 내의 튜플에 접근하는 것이고 두 번째는 튜플 내의 항목에 접근하는 것이다. 그렇게 해서 각 항목을 테이블 셀에 집어넣는다. <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code> 등의 문을 모두 <code class="docutils literal notranslate"><span class="pre">%end</span></code>로 닫아 주는 걸 잊지 말자. 안 그러면 기대와 다른 결과가 나올 수 있다.</p>
<p>템플릿의 파이썬 코드 아닌 행에서 변수에 접근해야 한다면 이중 중괄호로 감싸면 된다. 그러면 템플릿에서 그 변수의 실제 값을 대신 집어넣어 준다.</p>
<p>스크립트를 다시 실행해서 결과를 보자. 아직 대단히 멋진 건 아니지만 적어도 튜플 리스트보단 읽기에 좋다. 당연히 위의 초간단 HTML 마크업에다가 가령 인라인 스타일로 양념을 쳐서 더 보기 좋은 출력을 얻을 수도 있다.</p>
<p class="rubric">GET과 POST의 값 사용하기</p>
<p>미완료 항목 전체를 제대로 볼 수 있게 됐으니 다음 단계로 가 보자. 할일 목록에 새 항목을 추가하는 거다. 일반 HTML 기반 양식으로 새 항목을 받게 되는데 GET 메소드로 데이터를 받는다.</p>
<p>먼저 스크립트에 새 라우트를 설치하고 GET 데이터를 받을 거라고 라우트에 지정하자.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">request</span>
<span class="o">...</span>
<span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;make_table&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
<span class="o">...</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/new&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_item</span><span class="p">():</span>

    <span class="n">new</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (?,?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;The new task was inserted into the database, the ID is </span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">new_id</span>
</pre></div>
</div>
<p>GET (또는 POST) 데이터에 접근하려면 보틀에서 <code class="docutils literal notranslate"><span class="pre">request</span></code>를 임포트해야 한다. 실제 데이터를 변수에 할당하기 위해 <code class="docutils literal notranslate"><span class="pre">request.GET.get('task',</span> <span class="pre">'').strip()</span></code> 문을 쓰는데, 여기서 <code class="docutils literal notranslate"><span class="pre">task</span></code>는 접근하려는 GET 데이터의 이름이다. 이게 전부다. GET 데이터 값이 여러 개라면 <code class="docutils literal notranslate"><span class="pre">request.GET.get()</span></code> 문을 여러 번 써서 다른 변수에 할당할 수도 있다.</p>
<p>코드 나머지 부분에선 얻은 데이터를 처리한다. 데이터베이스에 기록하고, 대응하는 ID를 데이터베이스에서 얻고, 출력을 만들어 낸다.</p>
<p>그런데 GET 데이터는 어디서 오는 걸까? 일단, 양식이 들어 있는 고정된 HTML 페이지를 이용할 수 있다. 아니면 지금 우리가 할 것처럼 GET 데이터 없이 <code class="docutils literal notranslate"><span class="pre">/new</span></code> 라우트를 호출했을 때 템플릿으로 출력할 수도 있다.</p>
<p>코드를 다음처럼 확장해야 한다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/new&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_item</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (?,?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;The new task was inserted into the database, the ID is </span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">new_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;new_task.tpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">new_task.tpl</span></code>은 다음과 같다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">task</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ToDo</span> <span class="nb">list</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/new&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">maxlength</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;save&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>이게 전부다. 보다시피 이번 템플릿은 그냥 HTML이다.</p>
<p>이제 할일 목록을 늘여 나갈 수 있다.</p>
<p>한편으로 POST 데이터를 선호한다면, 돌아가는 방식은 동일하니까 <code class="docutils literal notranslate"><span class="pre">request.POST.get()</span></code>으로 써 주기만 하면 된다.</p>
<p class="rubric">기존 항목 편집하기</p>
<p>마지막은 기존 항목을 편집할 수 있게 하는 거다.</p>
<p>우리가 알고 있는 라우트만 이용해도 가능하긴 하지만 꽤 까다로울 수 있다. 하지만 보틀에는 “동적 라우트”라는 게 있어서 이 작업이 상당히 쉬워진다.</p>
<p>동적 라우트의 기본 형식은 다음과 같다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/myroute/:something&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>여기서 중요한 건 콜론이다. <code class="docutils literal notranslate"><span class="pre">:something</span></code>에 대해 다음 슬래시까지 어떤 문자열이든 받는다. 그리고 <code class="docutils literal notranslate"><span class="pre">something</span></code>의 값이 그 라우트에 할당된 함수로 전달돼서 그 데이터를 함수 안에서 처리할 수 있다.</p>
<p>할일 목록을 위해 <code class="docutils literal notranslate"><span class="pre">&#64;route('/edit/:no)</span></code> 라우트를 만들 것이다. 여기서 <code class="docutils literal notranslate"><span class="pre">no</span></code>는 편집할 항목의 ID다.</p>
<p>코드는 다음과 같다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/edit/:no&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_item</span><span class="p">(</span><span class="n">no</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">edit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE todo SET task = ?, status = ? WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">edit</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">no</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;The item number </span><span class="si">%s</span><span class="s1"> was successfully updated&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">no</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">no</span><span class="p">)))</span>
        <span class="n">cur_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;edit_task&#39;</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">no</span><span class="o">=</span><span class="n">no</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GET</span></code> 데이터를 얻는 것을 포함해, 기본적으로 앞서 새 항목을 추가할 때와 거의 동일하다. 여기 추가된 건 동적 라우트 <code class="docutils literal notranslate"><span class="pre">:no</span></code>를 쓰는 것인데, 그 번호가 대응하는 함수로 전달된다. 보다시피 함수 안에서 <code class="docutils literal notranslate"><span class="pre">no</span></code>를 사용해 데이터베이스의 해당 데이터 행에 접근한다.</p>
<p>함수에서 호출하는 <code class="docutils literal notranslate"><span class="pre">edit_task.tpl</span></code> 템플릿은 다음과 같다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="c1"># 할일 편집용 템플릿</span>
<span class="o">%</span><span class="c1"># 이 템플릿은 &quot;no&quot; 값뿐 아니라 해당 할일 항목의 텍스트인 &quot;old&quot;도 받는다.</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Edit</span> <span class="n">the</span> <span class="n">task</span> <span class="k">with</span> <span class="n">ID</span> <span class="o">=</span> <span class="p">{{</span><span class="n">no</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/edit/{{no}}&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;{{old[0]}}&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">maxlength</span><span class="o">=</span><span class="s2">&quot;100&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">select</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span><span class="nb">open</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span><span class="n">closed</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;save&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>앞서 설명한 것처럼 이번에도 템플릿에 파이썬 문과 HTML이 섞여 있다.</p>
<p>동적 라우트에 대해 하나만 더 얘기하자면, 좀 있다 보겠지만 동적 라우트에 정규 표현식까지 쓸 수 있다.</p>
<p class="rubric">동적 라우트 검사하기</p>
<p>동적 라우트를 쓰는 건 좋은데 많은 경우 라우트에서 동적인 부분을 검사할 필요가 있다. 예를 들어 위의 편집용 라우트에선 정수를 기대한다. 그런데 부동소수점수나 문자 등을 수신하면 파이썬 인터프리터가 예외를 던지게 되는데, 이는 바라는 방식이 아니다.</p>
<p>그런 경우를 위해 보틀에서 <code class="docutils literal notranslate"><span class="pre">&#64;validate</span></code> 데코레이터를 제공하는데, “입력”을 검사한 다음 함수로 전달한다. 검사를 적용하려면 코드를 다음처럼 확장하면 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">validate</span>
<span class="o">...</span>
<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/edit/:no&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">no</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_item</span><span class="p">(</span><span class="n">no</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
<p>먼저 보틀 프레임워크에서 <code class="docutils literal notranslate"><span class="pre">validate</span></code>를 임포트한 다음 &#64;validate 데코레이터를 적용하면 된다. 여기선 <code class="docutils literal notranslate"><span class="pre">no</span></code>가 정수인지 검사한다. 기본적으로 부동소수점수, 리스트 등의 모든 데이터 타입을 검사할 수 있다.</p>
<p>코드를 저장하고 <code class="docutils literal notranslate"><span class="pre">:no</span></code>에 “403 forbidden” 유발 값(가령 부동소수점수)을 줘서 다시 페이지를 호출해 보자. 그러면 예외가 아니라 정수가 필요하다는 “403 - Forbidden” 오류를 받게 된다.</p>
<p class="rubric">정규 표현식을 이용한 동적 라우트</p>
<p>보틀에선 라우트의 “동적인 부분”이 정규 표현식인 동적 라우트도 처리할 수 있다.</p>
<p>예를 들어서 할일 목록의 각 항목을 “item1” 같은 형식의 번호로 접근할 수 있어야 한다고 해 보자. 일단 항목마다 라우트를 만들고 싶진 않을 것이다. 그리고 단순한 동적 라우트로도 안 된다. 라우트에 고정으로 “item”이 포함돼 있기 때문이다.</p>
<p>이미 얘기한 것처럼 정규 표현식이 해결책이다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/item:item#[0-9]+#&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;This item number does not exist!&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Task: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>물론 이 예는 좀 작위적이다. 단순 동적 라우트에 검사 동작을 추가해서 쓰는 게 더 쉬울 것이다. 정규 표현식 라우트가 어떻게 동작하는지 보여 주려는 것이다. <code class="docutils literal notranslate"><span class="pre">&#64;route('/item:item#[0-9]+#')</span></code> 행의 앞 부분은 보통 라우트와 비슷하지만 #로 감싼 부분이 정규 표현식으로 해석돼서 라우트의 동적인 부분이 된다. 그래서 이 경우엔 0에서 9까지 숫자가 걸리게 하려는 것이다. 그 아래의 함수 “show_item”에서는 해당 항목이 데이터베이스에 있는지 여부를 확인한다. 있으면 그 할일의 텍스트를 반환한다. 보다시피 라우트의 정규 표현식 부분만 전달된다. 그리고 항상 문자열로 전달된다. 이 경우처럼 단순 정수인 경우도 마찬가지다.</p>
<p class="rubric">정적 파일 반환하기</p>
<p>라우트를 파이썬 함수에 연계시킬 필요는 없고 정적 파일만 반환하면 되는 경우가 있을 수 있다. 예를 들어 응용의 도움말 페이지가 있다면 그 페이지를 HTML 그대로 반환하고 싶을 수 있다. 다음처럼 하면 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="n">static_file</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/help&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">help</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="s1">&#39;help.html&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;/path/to/file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>일단 보틀에서 <code class="docutils literal notranslate"><span class="pre">static_file</span></code> 함수를 임포트해야 한다. 그리고 보다시피 <code class="docutils literal notranslate"><span class="pre">return</span></code> 문이 <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">static_file</span></code> 문으로 바뀐다. 적어도 두 인자가 필요한데, 반환할 파일의 이름과 파일 경로다. 파일이 응용과 같은 디렉터리에 있더라도 경로를 지정해야 한다. 그 경우 경로로 <code class="docutils literal notranslate"><span class="pre">'.'</span></code>를 쓸 수도 있다. 파일의 MIME 타입을 보틀에서 추측하지만 명시적으로 지정하고 싶다면 <code class="docutils literal notranslate"><span class="pre">static_file</span></code>에 <code class="docutils literal notranslate"><span class="pre">mimetype='text/html'</span></code>처럼 세 번째 인자를 더해 주면 된다. 동적 라우트를 포함한 어떤 종류의 라우트에도 <code class="docutils literal notranslate"><span class="pre">static_file</span></code>을 쓸 수 있다.</p>
<p class="rubric">JSON 데이터 반환하기</p>
<p>응용에서 출력 페이지를 직접 생성하는 게 아니라 이후 자바스크립트 등에서 처리할 데이터를 반환하고 싶은 경우가 있을 수 있다. 그런 경우를 위해 보틀에선 웹 응용 간 데이터 교환의 표준이나 마찬가지인 JSON 객체를 반환하는 걸 지원한다. 파이썬을 포함한 여러 프로그래밍 언어에서 JSON을 처리할 수 있다.</p>
<p>정규 표현식 라우트 예시에서 생성하는 데이터를 JSON 객체로 반환하고 싶다고 해 보자. 코드가 다음처럼 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/json:json#[0-9]+#&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_json</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">json</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span><span class="s1">&#39;This item number does not exist!&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Task&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</pre></div>
</div>
<p>보다시피 상당히 간단하다. 그냥 파이썬 딕셔너리를 반환하면 보틀이 자동으로 JSON 객체로 변환해서 보낸다. 그래서 가령 “<a class="reference external" href="http://localhost/json1">http://localhost/json1</a>”을 호출하면 보틀이 JSON 객체 <code class="docutils literal notranslate"><span class="pre">{&quot;Task&quot;:</span> <span class="pre">[&quot;Read</span> <span class="pre">A-byte-of-python</span> <span class="pre">to</span> <span class="pre">get</span> <span class="pre">a</span> <span class="pre">good</span> <span class="pre">introduction</span> <span class="pre">into</span> <span class="pre">Python&quot;]}</span></code>을 반환하게 된다.</p>
<p class="rubric">오류 잡기</p>
<p>다음 단계는 보틀 자체에서 오류를 잡아서 응용 사용자에게 어떤 오류 메시지도 보이지 않게 하는 것이다. 이를 위해 보틀에는 HTTP 오류에 할당할 수 있는 “오류 라우트”가 있다.</p>
<p>우리는 403 오류를 잡고 싶다. 코드는 다음과 같다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">error</span>

<span class="nd">@error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;The parameter you passed has the wrong format!&#39;</span>
</pre></div>
</div>
<p>즉 먼저 보틀에서 <code class="docutils literal notranslate"><span class="pre">error</span></code>를 임포트하고 <code class="docutils literal notranslate"><span class="pre">error(403)</span></code>으로 라우트를 정의하면 “403 forbidden” 오류를 모두 잡아 준다. 그 오류에 “mistake” 함수가 할당됐다. 참고로 <code class="docutils literal notranslate"><span class="pre">error()</span></code>는 필요하든 말든 항상 오류 코드를 전달해 준다. 따라서 함수에서 항상 인자를 한 개 받아야 한다. 안 그러면 동작하지 않는다.</p>
<p>마찬가지로 한 함수에 여러 오류 라우트를 할당할 수도 있고 여러 오류를 각각의 함수로 잡을 수도 있다. 즉 다음 코드도 잘 동작하고,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="nd">@error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;There is something wrong!&#39;</span>
</pre></div>
</div>
<p>다음 코드도 잘 동작한다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake403</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;The parameter you passed has the wrong format!&#39;</span>

<span class="nd">@error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake404</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;Sorry, this page does not exist!&#39;</span>
</pre></div>
</div>
<p class="rubric">정리</p>
<p>지금까지 내용을 모두 읽었으면 보틀이라는 WSGI 프레임워크가 어떻게 동작하는지 대략 이해할 수 있을 것이다. 그리고 각자의 응용에 보틀을 이용하기 위해 필요한 지식을 모두 얻은 것이다.</p>
<p>다음 장에선 더 큰 프로젝트에서 보틀을 쓰는 법을 간단히 소개한다. 그리고 높은 부하, 즉 대량의 웹 트래픽 하에서 더 잘 동작하는 웹 서버들과 함께 보틀을 돌리는 방법을 살펴볼 것이다.</p>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id14">서버 구성</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>지금까지 보틀의 표준 서버를 사용했는데, 파이썬에 딸려 있는 <a class="reference external" href="http://docs.python.org/library/wsgiref.html#module-wsgiref.simple_server">WSGI 참조 서버</a>다. 개발 용도에는 잘 맞지만 큰 응용에는 적합하지 않다. 하지만 다른 방법들을 보기 전에 표준 서버의 설정을 바꾸는 방법부터 살펴보자.</p>
<p class="rubric">다른 포트와 IP로 보틀 돌리기</p>
<p>기본적으로 보틀은 <code class="docutils literal notranslate"><span class="pre">localhost</span></code>라고도 하는 IP 주소 127.0.0.1에서 <code class="docutils literal notranslate"><span class="pre">8080</span></code> 포트로 페이지를 제공한다. 그 설정을 바꾸는 건 아주 간단하다. 보틀의 <code class="docutils literal notranslate"><span class="pre">run()</span></code> 함수에 추가 매개변수를 줘서 포트와 주소를 바꿀 수 있다.</p>
<p>포트를 바꾸려면 run 명령에 <code class="docutils literal notranslate"><span class="pre">port=포트번호</span></code>를 추가하면 된다. 예를 들어 다음처럼 하면 보틀이 80 포트에 리슨하게 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></div>
</div>
<p>보틀이 리슨하는 IP 주소를 바꾸려면 다음처럼 한다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;123.45.67.89&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>물론 두 매개변수를 함께 쓸 수도 있다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;123.45.67.89&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>다음 절의 설명처럼 다른 서버로 보틀을 돌릴 때도 <code class="docutils literal notranslate"><span class="pre">port</span></code>와 <code class="docutils literal notranslate"><span class="pre">host</span></code> 매개변수를 적용할 수 있다.</p>
<p class="rubric">다른 서버로 보틀 돌리기</p>
<p>앞서 얘기한 것처럼 개발 용도나 개인 내지 소수 사람들만 보틀 기반 응용을 쓸 때는 표준 서버가 딱 맞는다. 하지만 규모가 커지면 표준 서버가 병목이 될 수 있다. 단일 스레드라서 한 번에 한 요청만 처리할 수 있기 때문이다.</p>
<p>보틀에는 높은 부하에서 잘 동작하는 다중 스레드 서버들에 대한 어댑터가 이미 다양하게 갖춰져 있다. <a class="reference external" href="http://www.cherrypy.org/">Cherrypy</a>, <a class="reference external" href="http://github.com/william-os4y/fapws3">Fapws3</a>, <a class="reference external" href="http://trac.saddi.com/flup">Flup</a>, <a class="reference external" href="http://pythonpaste.org/">Paste</a>를 지원한다.</p>
<p>예를 들어 Paste 서버로 보틀을 돌리고 싶으면 다음 코드를 쓰면 된다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">PasteServer</span>
<span class="o">...</span>
<span class="n">run</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">PasteServer</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">FlupServer</span></code>, <code class="docutils literal notranslate"><span class="pre">CherryPyServer</span></code>, <code class="docutils literal notranslate"><span class="pre">FapwsServer</span></code>도 마찬가지로 동작한다.</p>
<p class="rubric">Apache에서 mod_wsgi로 보틀 돌리기</p>
<p>이미 <a class="reference external" href="http://www.apache.org">Apache</a>를 쓰고 있을 수도 있고 보틀 기반 응용을 큰 규모로 돌리고 싶을 수도 있다. 그렇다면 Apache와 <a class="reference external" href="http://code.google.com/p/modwsgi/">mod_wsgi</a>를 고려해 볼 차례다.</p>
<p>Apache 서버가 올라가 있고 mod_wsgi도 잘 동작하고 있다고 가정한다. 여러 리눅스 배포판에서 각각의 패키지 관리 시스템을 통해 mod_wsgi를 쉽게 설치할 수 있다.</p>
<p>보틀에 mod_wsgi를 위한 어댑터가 딸려 있으므로 쉽게 응용을 올릴 수 있다.</p>
<p>아래 예에서는 “할일 목록” 응용을 <code class="docutils literal notranslate"><span class="pre">http://www.mypage.com/todo</span></code>를 통해 접근할 수 있도록 하고 코드와 템플릿, SQLite 데이터베이스를 <code class="docutils literal notranslate"><span class="pre">/var/www/todo</span></code> 경로에 저장한다고 가정한다.</p>
<p>mod_wsgi를 통해 응용을 돌릴 때 꼭 해야 할 일이 코드에서 <code class="docutils literal notranslate"><span class="pre">run()</span></code> 문을 빼는 것이다. 안 그러면 제대로 동작하지 않는다.</p>
<p>그 다음엔 다음 내용으로 <code class="docutils literal notranslate"><span class="pre">adapter.wsgi</span></code>라는 파일을 만들자.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">bottle</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/var/www/todo/&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">todo</span> <span class="c1"># 응용 적재</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">default_app</span><span class="p">()</span>
</pre></div>
</div>
<p>그리고 같은 경로 <code class="docutils literal notranslate"><span class="pre">/var/www/todo</span></code>에 저장하자. 사실 확장자가 <code class="docutils literal notranslate"><span class="pre">.wsgi</span></code>기만 하면 파일 이름은 뭐든 괜찮다. 가상 호스트에서 파일을 가리키는 데만 이름이 쓰인다.</p>
<p>마지막으로 Apache 설정에 다음처럼 가상 호스트 설정을 추가해 줘야 한다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">VirtualHost</span> <span class="o">*&gt;</span>
    <span class="n">ServerName</span> <span class="n">mypage</span><span class="o">.</span><span class="n">com</span>

    <span class="n">WSGIDaemonProcess</span> <span class="n">todo</span> <span class="n">user</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">group</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span> <span class="n">threads</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">WSGIScriptAlias</span> <span class="o">/</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">adapter</span><span class="o">.</span><span class="n">wsgi</span>

    <span class="o">&lt;</span><span class="n">Directory</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">todo</span><span class="o">&gt;</span>
        <span class="n">WSGIProcessGroup</span> <span class="n">todo</span>
        <span class="n">WSGIApplicationGroup</span> <span class="o">%</span><span class="p">{</span><span class="n">GLOBAL</span><span class="p">}</span>
        <span class="n">Order</span> <span class="n">deny</span><span class="p">,</span><span class="n">allow</span>
        <span class="n">Allow</span> <span class="kn">from</span> <span class="nn">all</span>
    <span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">VirtualHost</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>서버를 재시작하고 나면 <code class="docutils literal notranslate"><span class="pre">http://www.mypage.com/todo</span></code>에서 할일 목록을 볼 수 있을 것이다.</p>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id15">끝으로</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>보틀 소개 및 따라하기가 이제 끝났다. 보틀의 기본 개념들을 배우고 보틀 프레임워크를 이용해 첫 번째 응용을 작성했다. 그리고 큰 작업에 맞게 조정하는 방법과 Apache 웹 서버에서 mod_wsgi로 보틀을 돌리는 방법을 살펴봤다.</p>
<p>시작할 때 말한 것처럼 이 따라하기가 보틀의 모든 면과 가능성을 보여 주진 못한다. 가령 파일 객체 및 스트림 받기와 인증 데이터 다루기를 여기선 건너뛰었다. 또한 템플릿 안에서 다른 템플릿을 호출할 수 있다는 것도 보여 주지 않았다. 그런 사항에 대한 소개는 <a class="reference external" href="http://bottlepy.org/docs/dev/tutorial.html">보틀 문서</a>를 참고하면 된다.</p>
</section>
<section id="id10">
<h2><a class="toc-backref" href="#id16">전체 예시 코드</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>조금씩 조금씩 개발한 할일 목록 예시의 전체 코드다.</p>
<p>주된 응용 코드 <code class="docutils literal notranslate"><span class="pre">todo.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">error</span>

<span class="c1"># mod_wsgi 위에서 돌릴 때만 필요</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">default_app</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/todo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">todo_list</span><span class="p">():</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, task FROM todo WHERE status LIKE &#39;1&#39;;&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;make_table&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/new&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_item</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO todo (task,status) VALUES (?,?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;The new task was inserted into the database, the ID is </span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">new_id</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;new_task.tpl&#39;</span><span class="p">)</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/edit/:no&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">no</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_item</span><span class="p">(</span><span class="n">no</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">edit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE todo SET task = ?, status = ? WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">edit</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">no</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;The item number </span><span class="si">%s</span><span class="s1"> was successfully updated&lt;/p&gt;&#39;</span> <span class="o">%</span><span class="n">no</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">no</span><span class="p">)))</span>
        <span class="n">cur_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;edit_task&#39;</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="n">cur_data</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">no</span><span class="p">)</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/item:item#[0-9]+#&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;This item number does not exist!&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Task: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/help&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">help</span><span class="p">():</span>

    <span class="n">static_file</span><span class="p">(</span><span class="s1">&#39;help.html&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/json:json#[0-9]+#&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_json</span><span class="p">(</span><span class="n">json</span><span class="p">):</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;todo.db&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT task FROM todo WHERE id LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">json</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span><span class="s1">&#39;This item number does not exist!&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Task&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>


<span class="nd">@error</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake403</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;There is a mistake in your url!&#39;</span>

<span class="nd">@error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mistake404</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;Sorry, this page does not exist!&#39;</span>


<span class="n">debug</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="n">reloader</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 응용을 개발 환경에서 운용 환경으로 옮길 때 reloader=True와 debug(True)를 반드시 제거할 것</span>
</pre></div>
</div>
<p>템플릿 <code class="docutils literal notranslate"><span class="pre">make_table.tpl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="c1"># 튜플의 리스트(또는 리스트의 리스트, 튜플의 튜플, ...)로 HTML 테이블을 생성하는 템플릿</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">The</span> <span class="nb">open</span> <span class="n">items</span> <span class="n">are</span> <span class="k">as</span> <span class="n">follows</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="o">&gt;</span>
<span class="o">%</span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
  <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
  <span class="o">%</span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">col</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
  <span class="o">%</span><span class="n">end</span>
  <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
<span class="o">%</span><span class="n">end</span>
<span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>템플릿 <code class="docutils literal notranslate"><span class="pre">edit_task.tpl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="c1"># 할일 편집용 템플릿</span>
<span class="o">%</span><span class="c1"># 이 템플릿은 &quot;no&quot; 값뿐 아니라 해당 할일 항목의 텍스트인 &quot;old&quot;도 받는다.</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Edit</span> <span class="n">the</span> <span class="n">task</span> <span class="k">with</span> <span class="n">ID</span> <span class="o">=</span> <span class="p">{{</span><span class="n">no</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/edit/{{no}}&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;{{old[0]}}&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">maxlength</span><span class="o">=</span><span class="s2">&quot;100&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">select</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span><span class="nb">open</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span><span class="n">closed</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;save&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>템플릿 <code class="docutils literal notranslate"><span class="pre">new_task.tpl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="c1"># 새 작업을 위한 양식 템플릿</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">task</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ToDo</span> <span class="nb">list</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/new&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">maxlength</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;save&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Bottle</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">따라하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">설정 (초안)</a></li>
<li class="toctree-l1"><a class="reference internal" href="routing.html">요청 라우팅</a></li>
<li class="toctree-l1"><a class="reference internal" href="stpl.html">SimpleTemplate 엔진</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 참조</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins/index.html">사용 가능한 플러그인들</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">따라하기: 할일 목록 응용</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id5">목표</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">시작하기 전에…</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">보틀 이용해 웹 기반 할일 목록 만들기</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">서버 구성</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">끝으로</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id10">전체 예시 코드</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="async.html">비동기 응용 입문</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">각종 해결법</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">자주 묻는 질문</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">릴리스 노트와 변경 로그</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html#id2">기여자</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">개발자를 위해</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugindev.html">플러그인 개발 안내서</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/index.html">사용 가능한 플러그인들</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="plugins/werkzeug.html" title="previous chapter">Bottle-Werkzeug</a></li>
      <li>Next: <a href="async.html" title="next chapter">비동기 응용 입문</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2009-2021, Marcel Hellkamp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/tutorial_app.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>